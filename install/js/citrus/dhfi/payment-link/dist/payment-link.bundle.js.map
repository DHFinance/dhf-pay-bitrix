{"version":3,"file":"payment-link.bundle.js","sources":["../src/payment-link.js"],"sourcesContent":["//import * as BX from 'main.core';\nimport {ajax as Ajax, Type, Reflection, Loc} from 'main.core';\nimport {Popup} from 'main.popup'\nimport 'ui.buttons';\nimport 'ui.notification';\n\nlet instance;\n\nexport class PaymentLink {\n    constructor() {\n    }\n\n    static getInstance() {\n        if (!instance) {\n            instance = new PaymentLink();\n        }\n        return instance;\n    }\n\n    /**\n     * @todo There should be another way to get invoice id?\n     */\n    showForDetail() {\n        const regex = /^invoice_(\\d+)/;\n        const editorId = BX.CrmProductEditor.getDefault().getId();\n        const matches = editorId.match(regex);\n        if (matches) {\n            this.show(+matches[1], document.getElementById('crm_invoice_toolbar_document'));\n        } else {\n            this.handleError(new Error(Loc.getMessage('CITRUS_DHFI_PAYMENT_LINK_FAILED_TO_DETECT_INVOICE_ID')))\n        }\n    }\n\n    show(invoiceId, bindElement) {\n        if (!Type.isInteger(invoiceId)) {\n            console.warn('Unexpected invoiceId', { invoiceId });\n            return;\n        }\n        BX.showWait();\n        // @todo cache results\n        Ajax.runAction('citrus:dhfi.integration.Invoice.getLink', {\n            json: {\n                invoiceId,\n            },\n        }).then(({data}) => {\n            this.showPopup(data.url, bindElement);\n        }).catch((response) => {\n            this.handleError(response);\n        });\n    }\n\n    notify(message) {\n        BX.UI.Notification.Center.notify({\n            content: message,\n            position: BX.UI.Notification.Position.TOP_CENTER,\n        });\n    }\n\n    handleError(err, userMessage) {\n        if (err instanceof Error) {\n            err = err.message;\n        } else if (typeof err === 'object'\n            && err !== null\n            && 'errors' in err\n        ) {\n            err = err.errors[0].message;\n        }\n\n        // eslint-disable-next-line no-console\n        console.error(err);\n        this.notify(userMessage || err);\n    }\n\n    showPopup(url, bindElement) {\n\n        BX.closeWait();\n        (new Popup({\n            id: 'citrus.dhfi-link',\n            bindElement: bindElement,\n            closeByEsc: true,\n            minWidth: 430,\n            autoHide: true,\n            events: {\n                onClose: (e) => {\n                    e.getTarget().destroy();\n                },\n            },\n            content: `\n            <div class=\"ui-ctl ui-ctl-wa\">\n                <input class=\"ui-ctl-element\"\n                       type=\"text\"\n                       value=\"${url}\"\n                       id=\"citrus-dhfi-generated-link\"\n                >\n                <button class=\"crm-invoice-edit-url-link-icon\" title=\"Copy to clipboard\" id=\"citrus-dhfi-clipboard-copy\" style=\"visibility: hidden\"></button>\n            </div>\n            `\n        }))\n            .show();\n\n        const copyToClipboardButton = document.getElementById('citrus-dhfi-clipboard-copy');\n        if (copyToClipboardButton) {\n            BX.clipboard.bindCopyClick(copyToClipboardButton, {text: url});\n            copyToClipboardButton.click();\n        }\n\n        const link = document.getElementById('citrus-dhfi-generated-link');\n        if (link) {\n            link.focus();\n            link.select();\n        }\n    }\n}\n\nReflection.namespace('BX.Citrus.DHFi').PaymentLink = PaymentLink;\n\n"],"names":["instance","PaymentLink","regex","editorId","BX","CrmProductEditor","getDefault","getId","matches","match","show","document","getElementById","handleError","Error","Loc","getMessage","invoiceId","bindElement","Type","isInteger","console","warn","showWait","Ajax","runAction","json","then","data","showPopup","url","response","message","UI","Notification","Center","notify","content","position","Position","TOP_CENTER","err","userMessage","errors","error","closeWait","Popup","id","closeByEsc","minWidth","autoHide","events","onClose","e","getTarget","destroy","copyToClipboardButton","clipboard","bindCopyClick","text","click","link","focus","select","Reflection","namespace"],"mappings":"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"}